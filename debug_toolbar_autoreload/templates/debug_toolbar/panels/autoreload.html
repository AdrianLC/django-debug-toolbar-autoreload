{% load i18n %}
<script type="text/javascript">//<![CDATA[
(function ($) {
    var template_resources = [{% for template in templates %}
        "{{ template|escapejs }}"{% if not forloop.last %},{% endif %}
    {% endfor %}];
    var media_resources = [];

    var findMediaResources = function () {
        var resources = media_resources + [];
        /* Find linked CSS files */
        $('link[rel=stylesheet]').each(function () {
            var url = $(this).attr('href');
            if (!url.match(/^data:/)) {
                resources.push($(this).attr('href'));
            }
        });
        return resources;
    };

    var initial_url = window.location.href;
    var reload = function () {
        window.location.href = initial_url;
    };
    var listenForChanges = function () {
        var data = [];
        $.each(template_resources, function (i, resource) {
            data.push('template=' + encodeURIComponent(resource));
        });
        $.each(findMediaResources(), function (i, resource) {
            data.push('media=' + encodeURIComponent(resource));
        });
        data = data.join('&');
        $.ajax({
            url: '/__debug__/autoreload/',
            type: 'GET',
            data: data,
            success: function (data, textStatus, jqXHR) {
                switch (jqXHR.status) {
                    case 200:
                        reload();
                        break;
                    case 0:
                    case 204:
                        setTimeout(listenForChanges, 500);
                        break;
                    default:
                        console.log('unhandled status code', jqXHR.status);
                        break;
                }
            },
            error: function () {
                console.log('ERROR', arguments);
                setTimeout(listenForChanges, 3000);
            }
        });
    };

    $(document).ready(function () {
        $('.djdt-reload').click(reload);
        listenForChanges();
    });
})(djdt.jQuery);
//]]></script>

<p>Auto-reloading is activated.</p>
<button class="djdt-reload">Reload page</button>

<h2>Monitoring:</h2>
<ul>
{% for template in templates %}
    <li><code>{{ template }}</code></li>
{% endfor %}
</ul>
