{% load i18n %}
<script type="text/javascript">//<![CDATA[
(function ($) {
    var initial_timestamp = new Date().getTime() / 1000;
    var template_resources = [{% for template in templates %}
        "{{ template|escapejs }}"{% if not forloop.last %},{% endif %}
    {% endfor %}];

    var showMonitoringList = function (resources) {
        var table = $('#djDebugAutoreloadPanel table.djDebugAutoreload-monitor tbody');
        $.each(resources, function (i, resource) {
            var monitor = true;
            var row = $(
                '<tr class="djDebug' + ((i+1) % 2 == 0 ? 'Even' : 'Odd') + '">' +
                    '<td><input type="checkbox" ' + (monitor ? 'checked ' : '') + 'disabled /></td>' +
                    '<td>' + resource.type + '</td>' +
                    '<td><code>' + resource.src + '</code></td>' +
                '</tr>');
            table.append(row);
        });
    };

    var findResources = function () {
        var resources = [];
        /* Templates */
        $.each(template_resources, function (i, filename) {
            resources.push({
                type: 'template',
                src: filename
            });
        });
        /* Find CSS files */
        $('link[rel=stylesheet]').each(function () {
            var url = $(this).attr('href');
            if (!url.match(/^data:/)) {
                resources.push({
                    type: 'css',
                    src: $(this).attr('href')
                });
            }
        });
        /* Find JS files */
        $('script[src]').each(function () {
            var url = $(this).attr('src');
            if (!url.match(/^data:/)) {
                resources.push({
                    type: 'js',
                    src: $(this).attr('src')
                });
            }
        });
        return resources;
    };

    var reload = function () {
        window.location.reload(true);
    };

    var listenForChanges = function () {
        var resources = findResources();
        var data = [];
        $.each(resources, function (i, resource) {
            var timestamp = initial_timestamp;
            var query_type = (resource.type == 'template' ? 'template' : 'media');
            data.push(
                query_type + '=' + 
                encodeURIComponent(resource.src) + ':' +
                timestamp);
        });
        data = data.join('&');
        $.ajax({
            url: "{{ AUTORELOAD_URL|escapejs }}",
            type: 'POST',
            data: data,
            success: function (data, textStatus, jqXHR) {
                switch (jqXHR.status) {
                    case 200:
                        reload();
                        break;
                    case 0:
                    case 204:
                        setTimeout(listenForChanges, 500);
                        break;
                    default:
                        console.log('unhandled status code', jqXHR.status);
                        break;
                }
            },
            error: function () {
                console.log('ERROR', arguments);
                setTimeout(listenForChanges, 3000);
            }
        });

        showMonitoringList(resources);
    };

    $(document).ready(function () {
        $('.djDebugAutoreload-reload').click(reload);
        listenForChanges();
    });
})(djdt.jQuery);
//]]></script>
<style type="text/css">
    .djDebugAutoreload-reload {
        float: right;
    }
    .djDebugAutoreload-monitor {
        clear: both;
    }
</style>

<button class="djDebugAutoreload-reload">Reload page</button>
<p>Auto-reloading is activated.</p>

<h2>Monitoring:</h2>
<table class="djDebugAutoreload-monitor">
    <thead>
        <th>Monitor</th>
        <th>Type</th>
        <th>Filename</th>
    </thead>
    <tbody>
    
    </tbody>
</table>
